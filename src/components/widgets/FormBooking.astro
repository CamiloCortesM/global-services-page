---
import ServiceSelectorStep from './ServiceSelectorStep.astro';
import ProgressBarStep from '../ui/ProgressBarStep.astro';
import ServiceDetailsStep from './ServiceDetailsStep.astro';
import Step4 from './Step4.astro';
import PersonalDetailsStep from './PersonalDetailsStep.astro';
---

<style is:global>
  .icon-step {
    background-color: white;
  }

  .icon-step span {
    color: rgb(75 85 99 / 1);
  }

  .icon-active {
    background-color: #464c8f;
  }

  .icon-active span {
    color: white;
  }

  .card {
    animation: fade 450ms ease-in-out forwards;
  }

  .card.active {
    animation: fade-back 250ms ease-in-out both;
  }

  @keyframes fade {
    0% {
      opacity: 1;
    }
    100% {
      opacity: 0;
    }
  }

  @keyframes fade-back {
    0% {
      opacity: 0;
    }
    100% {
      opacity: 1;
    }
  }
</style>

<script>
  import { servicesForms } from '@/utils/service-forms';
  import { transformServiceName } from '@/utils/utils';

  function init() {
    if (window.location.pathname !== '/booking') return;
    const multiStepForm = document.querySelector('[data-multi-step]');
    const fieldsets = [...(multiStepForm?.querySelectorAll('fieldset') || [])];
    const progressBar = document.querySelectorAll('#progressbar > div');
    const alertError = document.querySelector('#alter_error');

    let currentStep = 0;

    function showStep(step: number) {
      fieldsets?.forEach((fieldset, index) => {
        fieldset.classList.toggle('active', index === step);
      });

      progressBar.forEach((stepElement, index) => {
        if (index === 0) return;
        const isStepActive = index <= step;
        stepElement
          .querySelector('.line-icon-step')
          ?.classList.toggle('bg-[#464c8f]', isStepActive);
        stepElement
          .querySelector('.icon-step')
          ?.classList.toggle('icon-active', isStepActive);
      });
    }

    function getFormHTMLForService(service: string) {
      switch (service) {
        case 'Regular Cleaning':
          return servicesForms['Regular Cleaning'];
        case 'One off Cleaning':
          return servicesForms['One off Cleaning'];
        case 'End of Tenancy Cleaning':
          return servicesForms['End of Tenancy Cleaning'];
        case 'Antiviral Sanitisation':
          return servicesForms['Antiviral Sanitisation'];
        case 'Office Cleaning':
          return servicesForms['Office Cleaning'];
        case 'Carpet Cleaning':
          return servicesForms['Carpet Cleaning'];
        case 'Mattress Cleaning':
          return servicesForms['Mattress Cleaning'];
        case 'Upholstery Cleaning':
          return servicesForms['Upholstery Cleaning'];
        case 'Window Cleaning':
          return servicesForms['Window Cleaning'];
        case 'Curtain Cleaning':
          return servicesForms['Curtain Cleaning'];
        case 'Oven Cleaning':
          return servicesForms['Oven Cleaning'];
        case 'Rubbish Removal':
          return servicesForms['Rubbish Removal'];
        case 'Gardening':
          return servicesForms['Gardening'];
        case 'Maintenance service':
          return servicesForms['Maintenance service'];
        default:
          return '';
      }
    }

    let buttons: NodeListOf<Element> | null = null;
    let checkboxes: NodeListOf<Element> | null = null;
    let radios: NodeListOf<Element> | null = null;

    multiStepForm?.addEventListener('click', (e: any) => {
      let incrementor: number | null = null;
      if (e.target!.matches('[data-next]')) {
        incrementor = 1;
      } else if (e.target.matches('[data-previous]')) {
        currentStep += -1;
        return showStep(currentStep);
      }
      if (incrementor == null) return;

      switch (currentStep) {
        case 0:
          if (buttons && buttons?.length > 0) {
            buttons.forEach((button) => {
              button.removeEventListener('click', buttonClickHandler);
            });
          }

          if (checkboxes && checkboxes?.length > 0) {
            checkboxes.forEach((checkbox) => {
              checkbox.removeEventListener('change', checkboxChangeHandler);
            });
          }
          if (radios && radios?.length > 0) {
            radios.forEach((radio) => {
              radio.removeEventListener('change', checkboxChangeHandler);
            });
          }

          const h2Element = fieldsets[currentStep + 1].querySelector('h2');
          const selectElement = fieldsets[currentStep].querySelector('select');
          const formStep2 =
            fieldsets[currentStep + 1].querySelector('#form-step2');
          if (h2Element && selectElement && formStep2) {
            const selectedOptionText =
              selectElement.options[selectElement.selectedIndex].text;
            h2Element.textContent = selectedOptionText;
            const formHTML = getFormHTMLForService(selectedOptionText);
            formStep2.innerHTML = formHTML;

            buttons = formStep2.querySelectorAll('[data-input-counter]');
            buttons.forEach((button) => {
              button.addEventListener('click', buttonClickHandler);
            });

            checkboxes = formStep2.querySelectorAll('[input-option-checked]');
            checkboxes.forEach((checkbox) => {
              checkbox.addEventListener('change', checkboxChangeHandler);
            });

            radios = formStep2.querySelectorAll('[input-radio-checked]');
            radios.forEach((radio) => {
              radio.addEventListener('change', radioChangeHandler);
            });
          }
          break;
        case 2:
          const resumeZipcode = document.querySelector('#resume_zipcode');
          const resumeDate = document.querySelector('#resume_date');
          const resumeService = document.querySelector('#resume_service');
          const resumeName = document.querySelector('#resume_name');
          const resumeEmail = document.querySelector('#resume_email');
          const resumePhone = document.querySelector('#resume_phone');
          const resumeAddress = document.querySelector('#resume_address');

          const resumeServiceDetails: any = document.querySelector(
            '#resume_service_details'
          );
          resumeServiceDetails.innerHTML = '';
          const zipcode: any = document.querySelector('#grid-zip');
          const date: any = document.querySelector('#date');
          const selectOption: any = fieldsets[0].querySelector('select');
          const name: any = document.querySelector('#name');
          const email: any = document.querySelector('#email');
          const phone: any = document.querySelector('#phone');
          const address: any = document.querySelector('#address');
          const inputsService = [
            ...(fieldsets[1]?.querySelectorAll('input') || []),
          ];

          const bookingSummary = {};

          inputsService.forEach((input) => {
            const name: any = transformServiceName(
              input.getAttribute('name') || ''
            );
            const value = transformServiceName(input.value);

            if (!input.disabled) {
              if (input.type === 'checkbox') {
                if (!bookingSummary[name]) {
                  bookingSummary[name] = [];
                }
                if (input.checked) {
                  bookingSummary[name].push(value);
                }
              } else if (input.type === 'radio') {
                if (input.checked) {
                  bookingSummary[name] = value;
                }
              } else if (input.type === 'text') {
                bookingSummary[name] = value;
              }
            }
          });

          resumeZipcode!.textContent = zipcode.value;
          resumeDate!.textContent = date.value;
          resumeName!.textContent = name.value;
          resumeEmail!.textContent = email.value;
          resumePhone!.textContent = phone.value;
          resumeAddress!.textContent = address.value;
          resumeService!.textContent =
            selectOption.options[selectOption.selectedIndex].text;

          function addDetailToSummary(title, value) {
            const detailElement = document.createElement('p');
            detailElement.classList.add(
              'flex',
              'items-center',
              'text-sm',
              'text-gray-500'
            );
            detailElement.innerHTML = `
           <span class="font-semibold mr-1">${title}:</span> ${value}
          `;
            resumeServiceDetails.appendChild(detailElement);
          }

          Object.keys(bookingSummary).forEach((key) => {
            const value = bookingSummary[key];
            addDetailToSummary(key, value);
          });

          break;
      }
      //TODO: refactor all scripts
      //TODO: display validations in all service inputs
      //TODO: send the email with the data

      const inputs = [...fieldsets[currentStep].querySelectorAll('input')];
      inputs.forEach((input) => {
        const label = input.nextElementSibling;
        console.log(label);
        if (!input.reportValidity()) {
          if (input.classList.contains('hidden')) {
            label!.classList.add('border-red-500');
          } else {
            input.classList.add('border-red-500');
          }
        } else {
          if (input.classList.contains('hidden')) {
            label!.classList.remove('border-red-500');
          } else {
            input.classList.remove('border-red-500');
          }
        }
      });

      const allValid = inputs.every((input) => input.reportValidity());

      if (allValid) {
        alertError!.classList.add('hidden');
        alertError!.classList.remove('flex');
        currentStep += incrementor;
        showStep(currentStep);
      } else {
        alertError!.classList.remove('hidden');
        alertError!.classList.add('flex');

        alertError!.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    });

    function radioChangeHandler() {
      const targetId = this.getAttribute('input-radio-checked');
      const targetElement = document.getElementById(targetId);

      if (targetElement) {
        const inputElements = targetElement.querySelectorAll('input');
        inputElements.forEach((input) => {
          input.disabled = false;
        });
        targetElement.classList.add('block');
        targetElement.classList.remove('hidden');
      }

      const radios = document.querySelectorAll(
        `input[type="radio"][name="${this.name}"][input-radio-checked]:not(#${this.id})`
      );
      radios.forEach((radio) => {
        const otherTargetId: any = radio.getAttribute('input-radio-checked');
        const otherTargetElement = document.getElementById(otherTargetId);
        if (otherTargetElement) {
          const inputElements = otherTargetElement.querySelectorAll('input');
          inputElements.forEach((input) => {
            input.disabled = true;
          });
          otherTargetElement.classList.remove('block');
          otherTargetElement.classList.add('hidden');
        }
      });
    }

    function buttonClickHandler() {
      const inputId = this.getAttribute('data-input-counter');
      const operation = this.getAttribute('data-operation');
      const inputElement = document.getElementById(inputId) as HTMLInputElement;

      if (!inputElement) {
        return;
      }

      let minvalue = parseInt(inputElement.min) || 0;
      let value = parseInt(inputElement.value) || 0;

      if (operation === 'increment' && value < 9) {
        inputElement.value = (value + 1).toString();
      } else if (operation === 'decrement' && value > minvalue) {
        inputElement.value = (value - 1).toString();
      }
    }

    function checkboxChangeHandler() {
      const targetId = this.getAttribute('input-option-checked');
      const targetElement = document.getElementById(
        targetId
      ) as HTMLInputElement;

      if (!targetElement) {
        return;
      }

      const inputElements = targetElement.querySelectorAll('input');

      if (this.checked) {
        inputElements.forEach((input) => {
          input.disabled = false;
        });
        targetElement.classList.add('block');
        targetElement.classList.remove('hidden');
      } else {
        inputElements.forEach((input) => {
          input.disabled = true;
        });
        targetElement.classList.remove('block');
        targetElement.classList.add('hidden');
      }
    }

    fieldsets.forEach((step) => {
      step.addEventListener('animationend', (e: any) => {
        fieldsets[currentStep].classList.remove('hidden');
        e.target!.classList.toggle(
          'hidden',
          !e.target!.classList.contains('active')
        );
      });
    });
  }
  init();
  document.addEventListener('astro:after-swap', init);
</script>

<form data-multi-step class="bg-white p-4 md:p-12 w-full mx-auto relative">
  <div class="w-full py-6 px-2 md:px-10 my-4">
    <!-- progressbar -->
    <ProgressBarStep />

    <hr class="my-7 mx-2 md:mx-10 h-0.5 border-t-0 bg-neutral-100" />

    <ServiceSelectorStep />
    <ServiceDetailsStep />
    <PersonalDetailsStep />
    <Step4 />
  </div>
</form>
